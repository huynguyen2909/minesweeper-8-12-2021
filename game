#include <iostream>
#include <conio.h>
#include <cstdlib>
#include <ctime>
// row = 13; col = 9
#define row 20
#define column 20
// nomines 10
#define number_of_mines 15
using namespace std;

int board[row][column]; //khai báo bảng (sử dụng mảng)
bool check_opened[row][column]; //mảng này dùng để lưu trạng thái ô đã mở hay chưa (đã mở -> true; chưa mở -> false)
bool check_flagged[row][column]; //mảng này dùng để lưu trạng thái ô đã được cắm cờ hay chưa (đã cắm -> true; chưa cắm: -> false)
void tutorial(); //giới thiệu và hướng dẫn 
void prepare_board(); //khởi tạo các giá trị thô sơ cho bảng
void calculate_hints(int that_row, int that_column); //tính số mìn xung quanh ô
void spread(int that_row, int that_column); //mở ô ko còn mìn xung quanh -> đệ quy để mở tiếp các ô tương tự
int number_of_opened_boxes(); //hàm kiểm tra số ô đã mở
void draw_board(); //vẽ bảng (cập nhật sau mỗi lần chọn ô)
void game_over(int x); //display khi thắng hoặc thua
bool check_condition(int rowno, int colno); //kiểm tra tọa độ ô mà người chơi nhập vào có hợp lệ hay không

int main() 
{
    cout << "\n";
    gameplay:
    int i, j, tempr, tempc;
    int behaviour;
    int therownum = 0;
    int thecolnum = 0;

    tutorial();
    int number_of_safe_boxes = (row - 2) * (column - 2) - number_of_mines;
    prepare_board();

    //tạo mìn ngẫu nhiên, gán giá trị -1 cho ô nào có mìn
    srand(time(NULL));
    i = 1;
    while (i <= number_of_mines) 
    {
        tempr = rand()%(row-2) + 1; //rand()%(max - min + 1) + min để nhận kết quả trong đoạn [min;max] ~ rand()%((row -2) - 1 + 1) + 1
        tempc = rand()%(column-2) + 1;
        if (board[tempr][tempc] != 1) 
        {
            board[tempr][tempc] = -1; //ô nào có giá trị -1 thì là mìn
            calculate_hints(tempr,tempc);
            i++;
        }
    }
    
    /* GAMEPLAY */
    while (number_of_opened_boxes() != number_of_safe_boxes && board[therownum][thecolnum] != -1) 
    {
        cout << "\n";
        after_flagging:
        system("cls");
        draw_board();
        coordinate:
        cout << "Enter the coordinate of the box you'd like to play:" << endl;
        cout << "Column: "; cin >> thecolnum;
        cout << "Row   : "; cin >> therownum;
        cout << "Press 1 to open, press 2 to flag/unflag: "; cin >> behaviour;
        if (behaviour == 2) 
        {
            if (check_flagged[therownum][thecolnum] == false) check_flagged[therownum][thecolnum] = true;
            else check_flagged[therownum][thecolnum] = false;
            goto after_flagging;
        }
        if (check_condition(therownum, thecolnum) == false) 
        {
            draw_board();
            cout << "\nInput doesn't match the conditions, try again!\n\n";
            goto coordinate;
        }
        if(board[therownum][thecolnum] == 0) spread(therownum, thecolnum); //bấm vào ô rỗng (số 0 hoặc " ") thì mở thêm các ô bên cạnh
        else check_opened[therownum][thecolnum] = true; //set ô vừa mở thành true
        cout << '\n' << endl;
        system("cls");
    }

    game_over(board[therownum][thecolnum]);
    getch();
    goto gameplay;
    return 0;
}

/* ALL THE FUNCTIONS */
void tutorial() 
{
    cout << "Hello ohayou bonjour ni hao ma choi Minesweeper nha" << endl;
    cout << "Credit: Huu Hao & Trung Huy" << endl;
    cout << "DON'T KNOW HOW TO PLAY? READ THE DESCRIPTION CAREFULLY ^^" << endl;
    cout << "Description:" << endl;
    cout << "#1 Choose the coordinate of the box you want to open" << endl;
    cout << "#2 The row must be within the closed interval [1;11]" << endl;
    cout << "   The column must be within the closed interval [1;7]" << endl; 
    cout << "#3 (?): mystery box" << endl;
    cout << "   (X): box with mine (displayed when the game is over)" << endl;
    cout << "   1-8: the number of mines surrounding that box" << endl;
    cout << "   ( ): empty box or the number of mines surrounding that box is 0" << endl;
    cout << "Let's roll! Good luck :))" << endl;
    cout << "Press any key to begin...";
    getch();
    cout << "\n\n";
}

void prepare_board() 
{
    int i, j;
    for (i = 0; i < row; i++) 
    {
        for (j = 0; j < column; j++) 
        {
            board[i][j] = 0;
            check_opened[i][j] = false; //set tất cả các ô chưa mở thành false
            check_flagged[i][j] = false; //set tất cả các ô chưa cắm cờ thành false
        }
    }
    for (i = 0; i < row; i++) board[i][0]=board[i][column-1]=-4;
    for (i = 0; i < column; i++) board[0][i]=board[row-1][i]=-4;
}

void calculate_hints(int that_row, int that_column) 
{
    int i, j;
    for (i = that_row-1; i<= that_row+1; i++) 
    {
        for (j = that_column-1; j <= that_column+1; j++) 
        {
            if (board[i][j] >= 0) board[i][j]++;
        }
    }
}

void spread(int that_row, int that_column) 
{
    int i, j;
    for (i = that_row - 1; i <= that_row + 1; i++) 
    {
        for (j = that_column - 1; j <= that_column + 1; j++) 
        {
            if (check_opened[i][j] == false) 
            {
                check_opened[i][j] = true;
                if (board[i][j] == 0) spread(i, j);
            }
        }
    }
}

int number_of_opened_boxes() 
{
    int i, j, sum = 0;
    for (i = 1; i < row - 1; i++) // <= row - 2
    {
        for (j = 1; j < column - 1; j++) // <= col - 2
        {
            if (check_opened[i][j] == true) sum++;
        }
    }
    return sum;
}

bool check_condition(int rowno, int colno) 
{
    int i, flag1 = 0, flag2 = 0;
    for (i = 1; i < row - 1; i++) //<= row - 2
    {
        if (rowno == i) flag1++;
    }
    for (i = 1; i < column - 1; i++) // <= col - 2 
    {
        if (colno == i) flag2++;
    }
    if (flag1 == 0 || flag2 == 0) return false;
    return true;
}

/**
1) chữ số thể hiện số bom xung quanh
2) nếu không có bom xung quanh, ô sẽ hiện " "
3) những ô chưa mở sẽ là "(?)"
4) khi đã bấm trúng bom, ô có bom sẽ là "(X)"
**/
void draw_board() 
{
    int i, j;
    cout <<  "  ";
    if (column - 2 >= 9)
    {
        for (i = 1; i <= 8; i++)
        {
            cout << "  " << i << "  ";
        }
        cout << "  " << 9 << "    ";
        for (i = 10; i < column - 1; i++)
        {
            cout << i << "   ";
        }
    }
    else
    {
        for (i = 1; i < column - 1; i++)
        {
            cout << "  " << i << "  ";
        }
    }
    cout << "\n\n";
    for (i = 1; i < row - 1; i++) // <= row - 2
    {
        if (i <= 9) cout << i << " ";
        else cout << i;
        for (j = 1; j < column - 1; j++) // <= col - 2
        {
            switch(check_opened[i][j]) 
            {
                case true:
                    switch(board[i][j]) 
                    {
                        case 0: cout << "     " ; break;
                        default: cout << "  " << board[i][j] << "  ";
                    }
                    break;

                default:
                    switch (check_flagged[i][j])
                    {
                    case true:
                        cout << " *P* "; break;
                    
                    default:
                        cout << " (?) "; break;
                    }
                    // cout << " (?) "; break;
            }
        }
        cout << "\n" << endl;
    }
}

void game_over(int x) 
{
    int i, j;
    cout <<  "  "; 
    for (i = 1; i < column - 1; i++) // col - 2
    {
        cout << "  " << i << "  ";
    }
    cout << "\n\n";
    for (i = 1; i < row - 1; i++) // <= row - 2
    {
        if (i <= 9) cout << i << " ";
        else cout << i;
        for (j = 1; j < column - 1; j++) // col - 2
        {
            switch(board[i][j]) 
            {
                case 0: cout << "     " ; break;
                case -1: cout << " (X) "; break;
                default: cout << "  " << board[i][j] << "  ";
            }
        }
        cout << "\n" << endl;
    }
    if (x == -1) 
    {
        cout << "You were blown off by a mine :(" << endl;
        cout << "GAME OVER!" << endl;
        cout << "Press any key to play again" << endl;
    }
    else 
    {
        cout << "You are amazing! :D" << endl;
        cout << "YOU WIN" << endl;
        cout << "Press any key to play again" << endl;
    }
}
